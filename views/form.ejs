<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Form</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <style>

          label{
            color: black;
          }
          .width-res {
            width: 30%;
          }
          @media (max-width: 750px) {
            .width-res {
              width: 90% !important;
            }
          }
          .custom-input-bg{
            background-color: transparent !important
          }
          input{
            font-family: "Montserrat", sans-serif;
            
          }
          input:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          select:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          .w40 {
            width: <%- formType == 'header' || 'footer' ? '100%' : '48%' %>;
          }
          .flag-icon{
            width: 20px;
            height: 20px;
          }
          form{
            background-color: transparent !important;
          }
          button:hover{
            color: white !important;
            font-weight: 900;
          }

          input, select{
            border: none !important;
            border-bottom: 2px solid black !important;
          }

          label {
            font-weight: bold;
          }
        </style>
        <style>

          <%=form.css%>

        </style>
    </head>
    <p id="formId" hidden><%=form.id%></p>
    <body class="<%=formType%>">
        <div class="w-100">
            <div class="w-100">
                <form id="headform1"
                    class="text-white w-100"
                    method="post" target="_top">
                    <div class="<%-formType == 'header' || 'footer' ?"": "d-flex"%> justify-content-between">   
                      <div class="w40">
                        <%if(label == "true"){%>
                          <label style="color:black" for="<%=form.name_id%>"><%=inputLabel%></label>  
                        <%}%>
                          <input  style="height: 45px;" type="text" class="form-control rounded-0 custom-input-bg"
                              id="<%=form.name_id%>" placeholder="Full Name">
                      </div>
                      <%if(noemail != "true"){%>
                        <div class="w40">
                          <%if(label == "true"){%>
                            <label style="color:black" for="<%=form.email_id%>"><%=emailLabel%></label>  
                          <%}%>
                            <input  style="height: 45px;" type="email" class="form-control rounded-0 custom-input-bg "
                                id="<%=form.email_id%>" placeholder="Email">
                        </div>
                      <%}%>
                    </div>
                    <%if(label == "true"){%>
                      <label style="color:black" for="<%=form.phone_id%>"><%=phoneLabel%></label>  
                    <%}%>
                    <div class="mb-3 d-flex flex-row align-items-center phone-div">
                      <img src="/flag.svg" alt="Singapore Flag" class="flag-icon">
                      <input type="tel" style="height: 45px;" value="+65" class="form-control rounded-0 custom-input-bg "
                          id="<%=form.phone_id%>" placeholder="83974987">
                    </div>

                    <%if(formType == "registration"){%>
                      <%if(noselect1 != 'true'){%>
                      <%if(label == "true"){%>
                        <label style="color:black"><%=requestLabel%></label>  
                      <%}%>
                        <%if(reqtype == "checkbox"){%>
                          <div>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <div>
                                <input checked name="<%=requestOptions[i]%>" id="<%=requestOptions[i]%>" value="<%=requestOptions[i]%>" type="checkbox" class=" mt-2">
                                <label class="text-black  " for="<%=requestOptions[i]%>"><%=requestOptions[i]%></label>
                              </div>
                            <%}%>                                           
                            </div>
                          <%}else{%>
                          <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                            aria-label="Default select example">
                            <option selected disabled> <%= placeselect1 ? placeselect1 : 'Please Select' %></option>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                              <%}%>                   
                            </select>
                        <%}%>
                        <%}%>

                    <%}else if(formType == "header" || formType == "footer"){%>
                        <%if(label == "true"){%>
                          <label style="color:black"><%=requestLabel%></label>  
                        <%}%>

                        <%if(noselect1 != 'true'){%>
                        <%if(reqtype == "checkbox"){%>
                          <div>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <div>
                                <input checked name="<%=requestOptions[i]%>" id="<%=requestOptions[i]%>" value="<%=requestOptions[i]%>" type="checkbox" class=" mt-2">
                                <label class="text-black  " for="<%=requestOptions[i]%>"><%=requestOptions[i]%></label>
                              </div>
                            <%}%>                                           
                            </div>
                          <%}else{%>
                          <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                            aria-label="Default select example">
                            <option selected disabled> <%= placeselect1 ? placeselect1 : 'Please Select' %></option>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                              <%}%>                   
                            </select>
                        <%}%>
                        <%}%>

                        <%if(noselect2 != 'true'){%>
                          <%if(label == "true"){%>
                            <label style="color:black"><%=bedroomLabel%></label>  
                          <%}%>
                          <select name="Bedroom" id="<%=form.select1Id%>"  style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                            aria-label="Default select example">
                            <option selected disabled> <%= placeselect2 ? placeselect2 : 'Please Select' %></option>
                            <%for(let i = 0; i < bedroomOptions.length; i++){%>
                              <option value="<%=bedroomOptions[i]%>"><%=bedroomOptions[i]%></option>
                              <%}%>
                          </select>
                        <%}%>
                    <%}else if(formType == "chatbot"){%>
                      <%if(showselect1 == 'true'){%>
                        <%if(label == "true"){%>
                          <label style="color:black"><%=requestLabel%></label>  
                        <%}%>
                        <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                          aria-label="Default select example">
                          <option selected disabled> <%= placeselect1 ? placeselect1 : 'Please Select' %></option>
                          <%for(let i = 0; i < requestOptions.length; i++){%>
                            <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                            <%}%>                   
                          </select>
                      <%}%>

                      <%if(showselect2 == 'true'){%>
                        <%if(label == "true"){%>
                          <label style="color:black"><%=bedroomLabel%></label>  
                        <%}%>
                        <select name="Bedroom" id="<%=form.select1Id%>"  style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                          aria-label="Default select example">
                          <option selected disabled> <%= placeselect2 ? placeselect2 : 'Please Select' %></option>
                          <%for(let i = 0; i < bedroomOptions.length; i++){%>
                            <option value="<%=bedroomOptions[i]%>"><%=bedroomOptions[i]%></option>
                            <%}%>
                        </select>  
                      <%}%>
                      <%}%>
                      <% if (createdFieldsFlag == "true") { %>
                        <div class="created-fields-container">
                          <% for (let i = 0; i < createdFields.length; i++) { %>
                            <% let field = createdFields[i]; %>
                            <div id="<%=field.id%>" type="<%=field.type%>" question="<%=field.label%>">
                              <% if (field.type === 'input') { %>
                                <div class="">
                                  <%if(label == "true"){%>
                                    <label for="<%= field.id %>"><%= field.label %></label><br>
                                    <%}%>
                                    <input type="<%= field.inputType %>" class="custom-input-bg" style="height: 45px; width: 100%;" name="<%= field.id %>" placeholder="<%= field.placeholder %>" />
                                </div>
                              <% } else if (field.type === 'textarea') { %>
                                <div class="">
                                  <%if(label == "true"){%>
                                    <label for="<%= field.id %>"><%= field.label %></label><br>
                                    <%}%>
                                    <textarea class="form-control custom-input-bg" name="<%= field.id %>" placeholder="<%= field.placeholder %>"></textarea>
                                </div>
                              <% } else if (field.type === 'checkbox') { %>
                              
                                <%if(label == "true"){%>
                                  <label><%= field.label %></label><br>
                                <%}%>
                                <% for (let j = 0; j < field.options.length; j++) { %>
                                  <div class="d-flex">
                                    <input type="checkbox" id="<%= field.id %>-<%= j %>" name="<%= field.id %>" value="<%= field.options[j] %>">
                                    <label class="ms-3" for="<%= field.id %>-<%= j %>"><%= field.options[j] %></label><br>
                                  </div>
                                <% } %>
                              <% } else if (field.type === 'radio') { %>
                                <%if(label == "true"){%>
                                  <label><%= field.label %></label><br>
                                <%}%>
                                <% for (let j = 0; j < field.options.length; j++) { %>
                                  <div class="form-control d-flex">
                                    <input type="radio" id="<%= field.id %>-<%= j %>" name="<%= field.id %>" value="<%= field.options[j] %>">
                                    <label class="ms-3" for="<%= field.id %>-<%= j %>"><%= field.options[j] %></label><br>
                                  </div>
                                    <% } %>
                              <% } else if (field.type === 'select') { %>
                                <%if(label == "true"){%>
                                  <label><%= field.label %></label><br>
                                <%}%>
                                <select class="form-select custom-input-bg" style="height: 45px;" name="<%= field.id %>">
                                  <option selected disabled>Please Select</option>
                                  <% for (let j = 0; j < field.options.length; j++) { %>
                                    <option value="<%= field.options[j] %>"><%= field.options[j] %></option>
                                  <% } %>
                                </select>
                              <% } %>
                            </div>
                          <% } %>
                        </div>

                      <% } %>
                      <div class="mt-3 d-flex">
                        <input id="privacy_checkbox" checked type="checkbox">
                        <label for="privacy_checkbox" style="margin-left: 5px; font-weight: 300;">I consent to the collection, use, and disclosure of my personal data as specified in the <a onclick="openPrivacyPolicy()" style="cursor: pointer; font-weight: bold; color: black; text-decoration: none;">Privacy Policy.</a> </label>
                      </div>

                    <%if(devtext == "true"){%>  
                      <p class="text-black" style="white-space: pre-line;" >
                        <%-form.dev_info%>
                      </p>
                      <%}%>

                    <div class="text-center">
                        <button style="height: 45px; background-color:  transparent;" type="submit" id="submitBtn1"
                            class="w-100 rounded-0 border-0 hover-overlay btn custom-input-bg ">Send</button>
                    </div>
                    <p id="error_msg1" class="text-danger text-center"></p>
                </form>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
        <script>
          const noemail = "<%=noemail%>";
initializeFormValidation('submitBtn1', 'headform1', '<%=form.name_id%>', '<%=form.email_id%>', '<%=form.phone_id%>', 'error_msg1');

  function initializeFormValidation(ButtonID, FormID, NameID, EmailID, PhoneID, ErrorMsgID) {
    document.getElementById(FormID).setAttribute('action', document.referrer + 'thank-you');

    // get all params in the url

    const urlParams = new URLSearchParams(window.location.search);
    const utm_source = urlParams.get('utm_source');
    const utm_medium = urlParams.get('utm_medium');
    const utm_campaign = urlParams.get('utm_campaign');
    const utm_content = urlParams.get('utm_content');
    const utm_term = urlParams.get('utm_term');
    const match_type = urlParams.get('match_type');
    const extension = urlParams.get('extension');
    const device = urlParams.get('device');
    const location = urlParams.get('location');
    const placement_category = urlParams.get('placement_category');

        const errors = [];

        async function checkValidity(formID, nameTextID, emailTextID, phoneTextID, errorID) {
            const emailInput = document.getElementById(emailTextID);
            const nameInput = document.getElementById(nameTextID);
            const phoneInput = document.getElementById(phoneTextID);
            const errorElement = document.getElementById(errorID);
            const Form = document.getElementById(formID);

            try {
                const email = noemail == "true" ? "": emailInput.value.trim();
                const phone = phoneInput.value.trim();
                const name = nameInput.value.trim();

                errors.length = 0;

                const isValidName = validateName(name);
                const isValidEmail = noemail == "true" ? true: validateEmail(email);
                const isValidPhone = validatePhone(phone);
                if (!validateName(name) || !isValidEmail || !validatePhone(phone) || !validatePrivacyPolicy() || !validateSelect()) {
                    errorElement.innerText = errors[0];
                    return false;
                } else {
                    errorElement.innerText = '';
                }

                const response = await fetch('https://ipinfo.io/json?token=8122b43242b7f4')
                const data = await response.json();
                const ip_address = data.ip;




                if (errors.length > 0) {
                    errorElement.innerText = errors.join('\n');
                    return false;
                } else {

                    errorElement.innerText = '';
                    const dataToSave = {
                        client_id: null,
                        project_id: null,
                        is_verified: 0,
                        status: 'clear',
                        is_send_discord: 1,
                        name: name,
                        ph_number: phone.slice(3),
                        ip_address: ip_address,
                        source_url:document.referrer,
                        params:{
                          utm_source: utm_source || null,
                          utm_medium: utm_medium || null,
                          utm_campaign: utm_campaign || null,
                          utm_content: utm_content || null,
                          utm_term: utm_term || null,
                          match_type: match_type || null,
                          extension: extension || null,
                          device: device || null,
                          location: location || null,
                          placement_category: placement_category || null
                          
                        }
                    };

                    if (noemail == "true") {
                        dataToSave.email = "";
                    } else {
                        dataToSave.email = email;
                    }                    
                    
                    await sendToServer(dataToSave);
                    Form.submit();

                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById(ButtonID).addEventListener('click', async function(e) {
            e.preventDefault();
          disableBtn();
            await checkValidity(FormID, NameID, EmailID, PhoneID, ErrorMsgID);
            enableBtn();
        });

        const phoneNumberInput = document.getElementById(PhoneID);

    

        phoneNumberInput.addEventListener("input", function() {
          let phoneNumber = this.value.replace(/\D/g, '');
          phoneNumber = "+" + phoneNumber;
          if(!phoneNumber.startsWith("+65")){
            phoneNumber = "+65";
          }

          if(phoneNumber.length > 11){
            phoneNumber = phoneNumber.slice(0, 11);
          }

          this.value = phoneNumber; 
            // this.value = phoneNumber;
            console.log(phoneNumber.length);
            if (phoneNumber.length === 11) {
                this.setCustomValidity('');
            } else {
                this.setCustomValidity('Please enter a valid Singaporean phone number.');
            }
        });

        document.getElementById(FormID).addEventListener('submit', function(e) {
          document.querySelector("body").innerHTML = "<h1 class='text-center'>Thank you for submitting the form</h1>";
        });
      function validateEmail(email) {
          if (!email) {
            errors.push("Email cannot be empty.");
            return false;
          } else {
            const pattern = /^[\w\.-]+@[\w\.-]+\.\w+$/;
            if (!pattern.test(email)) {
              errors.push("Invalid email format.");
              return false;
            }
            return true;
          }
      }
        
      function validatePhone(phoneNumber) {
        phoneNumber = phoneNumber.slice(3);
          if (!phoneNumber) {
            errors.push("Phone number cannot be empty.")
            return false;
          } else {
            const phoneRegex = /^(8|9)\d{7}$/;
            if (!phoneRegex.test(phoneNumber)) {
              errors.push("Invalid phone number format.");
              return false;
            }
            return true;
          }
      }

      function validateSelect() {
          const selects = document.querySelectorAll('select');
          let isValid = true;
          for (const select of selects) {
              if (select.value === "" || select.options[select.selectedIndex].disabled) {
                  errors.push(`Please Fill All Fields.`);
                  isValid = false;
                  break;
              }
          }
          return isValid;
      }

      function validateName(name) {
          if(name === ""){
            errors.push("name cannot be empty.");
            return false;
          }
          return true;
      }

      function validatePrivacyPolicy() {
          const privacyCheckbox = document.getElementById('privacy_checkbox');
          if (!privacyCheckbox.checked) {
              errors.push('Please agree to the privacy policy.');
              return false;
          }
          return true;
      }

      function validateSelect(){
        // get params from the url
        const urlParams = new URLSearchParams(window.location.search);
        const reqselect1 = urlParams.get('reqselect1');
        const reqselect2 = urlParams.get('reqselect2');

        if(reqselect1 == 'true'){
          const select1 = document.querySelector('select[name="Request"]');
          if(!select1){
            return true;
          }


          if(select1.selectedIndex === 0){
            errors.push("Please select a request.");
            return false;
          }
        }

        if(reqselect2 == 'true'){
          const select2 = document.querySelector('select[name="Bedroom"]');
          if(!select2){
            return true;
          }

          if(select2.selectedIndex === 0){
            errors.push("Please select a bedroom.");
            return false;
          }


        }
        return true;
      
      }
  }


    function disableBtn() {
        const btn = document.getElementById('submitBtn1');
        btn.disabled = true;
        btn.innerText = "Sending...";
        btn.style.cursor = "not-allowed";
    }

    function enableBtn() {
        const btn = document.getElementById('submitBtn1');
        btn.disabled = false;
        btn.innerText = "Send";
        btn.style.cursor = "pointer";
    }





    async function sendToServer(data) {
      const createdFieldContainer = document.querySelector('.created-fields-container');
      const id = document.getElementById('formId').innerText;
        const selects = document.querySelectorAll('select');
        const selectValues = [];


     


        selects.forEach(select => {
          // Check if there is a selected option and if it's not disabled
          if (select.selectedIndex !== -1 && !select.options[select.selectedIndex].disabled) {
            selectValues.push({ name: select.name, value: select.value });
          }
            });

      if (createdFieldContainer) {
        const createdFields = createdFieldContainer.children;
        for (let i = 0; i < createdFields.length; i++) {
          const field = createdFields[i];
          const fieldType = field.getAttribute('type');
          const label = field.getAttribute('question');
          if (fieldType === 'input') {
            const input = field.querySelector('input');
            selectValues.push({name:label, value:input.value});
          } else if (fieldType === 'textarea') {
            const textarea = field.querySelector('textarea');
            selectValues.push({name:label, value:textarea.value});
          } else if (fieldType === 'checkbox') {
            const checkboxes = field.querySelectorAll('input[type="checkbox"]');
            const checkedValues = [];
            checkboxes.forEach(checkbox => {
              if (checkbox.checked) {
                checkedValues.push(checkbox.value);
              }
            });
            selectValues.push({name:label, value:checkedValues});
          } else if (fieldType === 'radio') {
            const radios = field.querySelectorAll('input[type="radio"]');
            let checkedValue = '';
            radios.forEach(radio => {
              if (radio.checked) {
                checkedValue = radio.value;
              }
            });
            selectValues.push({name:label, value:checkedValue});
          }
        }
      }  
       

        const reqtype = `<%-reqtype%>`

        if(reqtype == "checkbox"){
          const checkboxes = document.querySelectorAll('input[type="checkbox"]');
          let selectedReq = ""
          checkboxes.forEach(checkbox=>{
            if(checkbox.checked){
              selectedReq += checkbox.value + ", ";
            }
          })
          selectValues.push({name:"Request", value:selectedReq});
        }

        const res = await fetch(`/api/form/submit/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({data:data, selects:selectValues})
        });
        const response = await res.json();
        return;
    }



    function openPrivacyPolicy() {
      // Create the form element
      const form = document.createElement("form");

      // Set the form attributes
      form.setAttribute('action', document.referrer + 'privacy-policy');
      form.setAttribute('method', "post");
      form.setAttribute("target", "_blank");

      // Append the form to the body
      document.body.appendChild(form);

      // Submit the form
      form.submit();
    }


        </script>
    </body>
</html>