<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Form</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <style>
          .width-res {
            width: 30%;
          }
          @media (max-width: 750px) {
            .width-res {
              width: 90% !important;
            }
          }
          .custom-input-bg{
            background-color: transparent !important
          }
          input::placeholder{
            color:<%=form.text_color%> !important
          }
          input{
            font-family: "Montserrat", sans-serif;
            color: <%=form.text_color%> !important;
          }
          input:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          select:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          select,  button{
            color: <%=form.text_color%> !important;
          }
          option{
            background-color: <%=form.form_color%> !important;
          }
          .w40{
            width: 48%;
          }
          @media screen and (max-width:768px) {
            .w40{
              width: 100%;
            }
          }


        </style>
        <style>

          <%=form.css%>

        </style>
    </head>
    <p id="formId" hidden><%=form.id%></p>
    <body class="min-vw-100 min-vh-100 bg-light">
        <div class="w-100 min-vh-100 d-flex justify-center align-middle">
            <div class="width-res mx-auto d-flex align-items-center">
                <form id="headform1"
                  style="background-color: <%=form.form_color%> !important;"
                    class="align-middle text-white mx-auto border px-3 py-5 w-100 bg-white shadow-md"
                    method="post">
                    <div class="d-lg-flex d-md-flex  justify-content-between">   
                      <div class="mb-3 w40">
                          <input  style="height: 45px;" type="text" class="form-control border-0 border-bottom border-3 rounded-0 custom-input-bg"
                              id="<%=form.name_id%>" placeholder="Full Name">
                      </div>
                      <div class="mb-3 w40">
                          <input  style="height: 45px;" type="email" class="form-control rounded-0 custom-input-bg border-0 border-bottom border-3"
                              id="<%=form.email_id%>" placeholder="Email">
                      </div>
                    </div>
                    <div class="mb-3">
                        <input type="tel"  style="height: 45px;" class="form-control rounded-0 custom-input-bg border-0 border-bottom border-3"
                            id="<%=form.phone_id%>" placeholder="+6583974987" >
                    </div>

                    <%if(formType == "registration"){%>
                        <!-- <select id="<%=form.select2_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg border-0 border-bottom border-3"
                            aria-label="Default select example">
                            <%for(let i = 0; i < condoOptions.length; i++){%>
                              <option value="<%=condoOptions[i]%>"><%=condoOptions[i]%></option>
                              <%}%>
                        </select> -->
                      
                        <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg border-0 border-bottom border-3"
                            aria-label="Default select example">
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                              <%}%>                   
                        </select>
                    <%}else if(formType == "header" || formType == "footer"){%>
                      <select name="Bedroom" id="<%=form.select1Id%>"  style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg border-0 border-bottom border-3"
                        aria-label="Default select example">

                        <%for(let i = 0; i < bedroomOptions.length; i++){%>
                          <option value="<%=bedroomOptions[i]%>"><%=bedroomOptions[i]%></option>
                          <%}%>
                      </select>
                      <select name="Request" id="<%=form.select3Id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg border-0 border-bottom border-3"
                        aria-label="Default select example">
                        <%for(let i = 0; i < requestOptions.length; i++){%>
                          <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                          <%}%>                   
                      </select>
                    <%}%>

                    <div class="text-center">
                        <button style="height: 45px; background-color: <%=form.btn_color%> !important;" type="submit" id="submitBtn1"
                            class="w-100 rounded-0 border-0 hover-overlay btn custom-input-bg ">Send</button>
                    </div>
                    <p id="error_msg1" class="text-danger text-center"></p>
                </form>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
        <script>
initializeFormValidation('submitBtn1', 'headform1', '<%=form.name_id%>', '<%=form.email_id%>', '<%=form.phone_id%>', 'error_msg1');

  function initializeFormValidation(ButtonID, FormID, NameID, EmailID, PhoneID, ErrorMsgID) {
        const errors = [];

        async function checkValidity(formID, nameTextID, emailTextID, phoneTextID, errorID) {
            const emailInput = document.getElementById(emailTextID);
            const nameInput = document.getElementById(nameTextID);
            const phoneInput = document.getElementById(phoneTextID);
            const errorElement = document.getElementById(errorID);
            const Form = document.getElementById(formID);

            try {
                const email = emailInput.value.trim();
                const phone = phoneInput.value.trim();
                const name = nameInput.value.trim();

                errors.length = 0;

                if (!validateEmail(email) || !validatePhone(phone)) {
                    errorElement.innerText = errors.join('\n');
                    return false;
                } else {
                    errorElement.innerText = '';
                }

                const response = await fetch('https://api.ipify.org?format=json')
                const data = await response.json();
                const ip_address = data.ip;




                if (errors.length > 0) {
                    errorElement.innerText = errors.join('\n');
                    return false;
                } else {
                    errorElement.innerText = '';
                    const dataToSave = {
                        client_id: null,
                        project_id: null,
                        is_verified: 0,
                        status: 'clear',
                        is_send_discord: 1,
                        email: email,
                        name: name,
                        ph_number: phone,
                        ip_address: ip_address
                    };
                    await sendToServer(dataToSave);
                    Form.submit();
                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById(ButtonID).addEventListener('click', function(e) {
            e.preventDefault();
            checkValidity(FormID, NameID, EmailID, PhoneID, ErrorMsgID);
        });

        const phoneNumberInput = document.getElementById(PhoneID);

        phoneNumberInput.addEventListener("focus", function() {
            if (!this.value.startsWith('+65')) {
                this.value = '+65' + this.value.replace(/\D/g, '');
            }
        });

        phoneNumberInput.addEventListener("input", function() {
            let phoneNumber = this.value.replace(/\D/g, '');
            phoneNumber = phoneNumber.slice(0, 10);
            if (!phoneNumber.startsWith('+65')) {
                phoneNumber = '+65' + phoneNumber.slice(2);
            }
            this.value = phoneNumber;
            if (phoneNumber.length === 10) {
                this.setCustomValidity('');
            } else {
                this.setCustomValidity('Please enter a valid 11-digit Singaporean phone number.');
            }
        });

        document.getElementById(FormID).addEventListener('submit', function(e) {
            e.preventDefault();
            window.parent.location = document.referrer + "thank-you";
        });
      function validateEmail(email) {
          if (!email) {
            errors.push("Email cannot be empty.");
            return false;
          } else {
            const pattern = /^[\w\.-]+@[\w\.-]+\.\w+$/;
            if (!pattern.test(email)) {
              errors.push("Invalid email format.");
              return false;
            }
            return true;
          }
        }
        
        function validatePhone(phoneNumber) {
        if (!phoneNumber) {
          errors.push("Phone number cannot be empty.")
          return false;
        } else {
          const phoneRegex = /\+65(8|9)\d{7}/;
          if (!phoneRegex.test(phoneNumber)) {
            errors.push("Invalid phone number format.");
            return false;
          }
          return true;
        }
      }
}

async function sendToServer(data) {
    const id = document.getElementById('formId').innerText;
    const selects = document.querySelectorAll('select');
    const selectValues = [];
    selects.forEach(select => {
        selectValues.push({name:select.name, value:select.value});
    });

    const res = await fetch(`/api/form/submit/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({data:data, selects:selectValues})
    });
    const response = await res.json();
    return;
}
        </script>
    </body>
</html>