<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Form</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <style>
          .width-res {
            width: 30%;
          }
          @media (max-width: 750px) {
            .width-res {
              width: 90% !important;
            }
          }
          .custom-input-bg{
            background-color: transparent !important
          }
          input{
            font-family: "Montserrat", sans-serif;
            
          }
          input:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          select:focus{
            outline: none !important;
            box-shadow: none !important;
          }
          .w40 {
            width: <%- formType == 'header' || 'footer' ? '100%' : '48%' %>;
          }
          .flag-icon{
            width: 20px;
            height: 20px;
          }
          form{
            background-color: transparent !important;
          }
          button:hover{
            color: black !important;
          }

          input, select{
            border: none !important;
            border-bottom: 2px solid black !important;
          }

          label {
            font-weight: bold;
          }
        </style>
        <style>

          <%=form.css%>

        </style>
    </head>
    <p id="formId" hidden><%=form.id%></p>
    <body class="<%=formType%>">
        <div class="w-100">
            <div class="w-100">
                <form id="headform1"
                    class="text-white w-100"
                    method="post" target="_top">
                    <div class="<%-formType == 'header' || 'footer' ?"": "d-flex"%> justify-content-between">   
                      <div class="w40">
                        <%if(label == "true"){%>
                          <label style="color:black" for="<%=form.name_id%>"><%=inputLabel%></label>  
                        <%}%>
                          <input  style="height: 45px;" type="text" class="form-control rounded-0 custom-input-bg"
                              id="<%=form.name_id%>" placeholder="Full Name">
                      </div>
                      <div class="w40">
                        <%if(label == "true"){%>
                          <label style="color:black" for="<%=form.email_id%>"><%=emailLabel%></label>  
                        <%}%>
                          <input  style="height: 45px;" type="email" class="form-control rounded-0 custom-input-bg "
                              id="<%=form.email_id%>" placeholder="Email">
                      </div>
                    </div>
                    <%if(label == "true"){%>
                      <label style="color:black" for="<%=form.phone_id%>"><%=phoneLabel%></label>  
                    <%}%>
                    <div class="mb-3 d-flex flex-row align-items-center phone-div">
                      <img src="/flag.svg" alt="Singapore Flag" class="flag-icon">
                      <input type="tel" style="height: 45px;" value="+65" class="form-control rounded-0 custom-input-bg "
                          id="<%=form.phone_id%>" placeholder="83974987">
                    </div>

                    <%if(formType == "registration"){%>
                      <%if(label == "true"){%>
                        <label style="color:black"><%=requestLabel%></label>  
                      <%}%>
                        <%if(reqtype == "checkbox"){%>
                          <div>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <div>
                                <input checked name="<%=requestOptions[i]%>" id="<%=requestOptions[i]%>" value="<%=requestOptions[i]%>" type="checkbox" class=" mt-2">
                                <label class="text-black  " for="<%=requestOptions[i]%>"><%=requestOptions[i]%></label>
                              </div>
                            <%}%>                                           
                            </div>
                          <%}else{%>
                          <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                            aria-label="Default select example">
                            <option selected disabled>Please Select</option>
                            <%for(let i = 0; i < requestOptions.length; i++){%>
                              <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                              <%}%>                   
                            </select>
                        <%}%>
                    <%}else if(formType == "header" || formType == "footer"){%>
                      <%if(label == "true"){%>
                        <label style="color:black"><%=requestLabel%></label>  
                      <%}%>
                      <%if(reqtype == "checkbox"){%>
                        <div>
                          <%for(let i = 0; i < requestOptions.length; i++){%>
                            <div>
                              <input checked name="<%=requestOptions[i]%>" id="<%=requestOptions[i]%>" value="<%=requestOptions[i]%>" type="checkbox" class=" mt-2">
                              <label class="text-black  " for="<%=requestOptions[i]%>"><%=requestOptions[i]%></label>
                            </div>
                          <%}%>                                           
                          </div>
                        <%}else{%>
                        <select name="Request" id="<%=form.select3_id%>" style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                          aria-label="Default select example">
                          <option selected disabled>Please Select</option>
                          <%for(let i = 0; i < requestOptions.length; i++){%>
                            <option value="<%=requestOptions[i]%>"><%=requestOptions[i]%></option>
                            <%}%>                   
                          </select>
                      <%}%>
                      <%if(label == "true"){%>
                        <label style="color:black"><%=bedroomLabel%></label>  
                      <%}%>
                      <select name="Bedroom" id="<%=form.select1Id%>"  style="height: 45px;" class="form-select mb-3 rounded-0 custom-input-bg "
                        aria-label="Default select example">
                        <option selected disabled>Select Bedroom</option>
                        <%for(let i = 0; i < bedroomOptions.length; i++){%>
                          <option value="<%=bedroomOptions[i]%>"><%=bedroomOptions[i]%></option>
                          <%}%>
                      </select>
                    <%}%>
                    <%if(devtext == "true"){%>  
                      <p class="text-black" style="white-space: pre-line;" >
                        <%-form.dev_info%>
                      </p>
                      <%}%>
                    <div class="text-center">
                        <button style="height: 45px; background-color:  transparent;" type="submit" id="submitBtn1"
                            class="w-100 rounded-0 border-0 hover-overlay btn custom-input-bg ">Send</button>
                    </div>
                    <p id="error_msg1" class="text-danger text-center"></p>
                </form>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
        <script>
initializeFormValidation('submitBtn1', 'headform1', '<%=form.name_id%>', '<%=form.email_id%>', '<%=form.phone_id%>', 'error_msg1');

  function initializeFormValidation(ButtonID, FormID, NameID, EmailID, PhoneID, ErrorMsgID) {
    document.getElementById(FormID).setAttribute('action', document.referrer + 'thank-you');


        const errors = [];

        async function checkValidity(formID, nameTextID, emailTextID, phoneTextID, errorID) {
            const emailInput = document.getElementById(emailTextID);
            const nameInput = document.getElementById(nameTextID);
            const phoneInput = document.getElementById(phoneTextID);
            const errorElement = document.getElementById(errorID);
            const Form = document.getElementById(formID);

            try {
                const email = emailInput.value.trim();
                const phone = phoneInput.value.trim();
                const name = nameInput.value.trim();

                errors.length = 0;

                console.log(name, email, phone);
                const isValidName = validateName(name);
                const isValidEmail = validateEmail(email);
                const isValidPhone = validatePhone(phone);
                console.log(isValidName, isValidEmail, isValidPhone);
                if (!validateName(name) || !validateEmail(email) || !validatePhone(phone)) {

                    errorElement.innerText = errors.join('\n');
                    return false;
                } else {
                    errorElement.innerText = '';
                }

                const response = await fetch('https://api.ipify.org?format=json')
                const data = await response.json();
                const ip_address = data.ip;




                if (errors.length > 0) {
                    errorElement.innerText = errors.join('\n');
                    return false;
                } else {
            console.log("b")

                    errorElement.innerText = '';
                    const dataToSave = {
                        client_id: null,
                        project_id: null,
                        is_verified: 0,
                        status: 'clear',
                        is_send_discord: 1,
                        email: email,
                        name: name,
                        ph_number: phone.slice(3),
                        ip_address: ip_address
                    };
                    await sendToServer(dataToSave);
                    Form.submit();

                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById(ButtonID).addEventListener('click', function(e) {
            e.preventDefault();
            console.log("clicked")
            checkValidity(FormID, NameID, EmailID, PhoneID, ErrorMsgID);
        });

        const phoneNumberInput = document.getElementById(PhoneID);

    

        phoneNumberInput.addEventListener("input", function() {
          let phoneNumber = this.value.replace(/\D/g, '');
          phoneNumber = "+" + phoneNumber;
          if(!phoneNumber.startsWith("+65")){
            phoneNumber = "+65";
          }

          if(phoneNumber.length > 11){
            phoneNumber = phoneNumber.slice(0, 11);
          }

          this.value = phoneNumber; 
            // this.value = phoneNumber;
            console.log(phoneNumber.length);
            if (phoneNumber.length === 11) {
                this.setCustomValidity('');
            } else {
                this.setCustomValidity('Please enter a valid Singaporean phone number.');
            }
        });

        document.getElementById(FormID).addEventListener('submit', function(e) {
          document.querySelector("body").innerHTML = "<h1 class='text-center'>Thank you for submitting the form</h1>";
        });
      function validateEmail(email) {
          if (!email) {
            errors.push("Email cannot be empty.");
            return false;
          } else {
            const pattern = /^[\w\.-]+@[\w\.-]+\.\w+$/;
            if (!pattern.test(email)) {
              errors.push("Invalid email format.");
              return false;
            }
            return true;
          }
      }
        
      function validatePhone(phoneNumber) {
        phoneNumber = phoneNumber.slice(3);
          if (!phoneNumber) {
            errors.push("Phone number cannot be empty.")
            return false;
          } else {
            const phoneRegex = /^(8|9)\d{7}$/;
            if (!phoneRegex.test(phoneNumber)) {
              errors.push("Invalid phone number format.");
              return false;
            }
            return true;
          }
      }

      function validateSelect() {
          const selects = document.querySelectorAll('select');
          let isValid = true;
          for (const select of selects) {
              if (select.value === "" || select.options[select.selectedIndex].disabled) {
                  errors.push(`Please Fill All Fields.`);
                  isValid = false;
                  break;
              }
          }
          return isValid;
      }

      function validateName(name) {
          if(name === ""){
            errors.push("name cannot be empty.");
            return false;
          }
          return true;
      }
      }

async function sendToServer(data) {
    const id = document.getElementById('formId').innerText;
    const selects = document.querySelectorAll('select');
    const selectValues = [];
    selects.forEach(select => {
       // Check if there is a selected option and if it's not disabled
  if (select.selectedIndex !== -1 && !select.options[select.selectedIndex].disabled) {
    selectValues.push({ name: select.name, value: select.value });
  }
    });

    const reqtype = `<%-reqtype%>`

    if(reqtype == "checkbox"){
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      let selectedReq = ""
      checkboxes.forEach(checkbox=>{
        if(checkbox.checked){
          selectedReq += checkbox.value + ", ";
        }
      })
      selectValues.push({name:"Request", value:selectedReq});
    }

    const res = await fetch(`/api/form/submit/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({data:data, selects:selectValues})
    });
    const response = await res.json();
    return;
}
        </script>
    </body>
</html>